# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (for dev branch only)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - prod-26
          - prod-27
          - dev

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Main branch deployment - FTP + Firebase (prod-26)
  deploy_main:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY_PROD_26 }}
      NEXT_PUBLIC_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN_PROD_26 }}
      NEXT_PUBLIC_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROJECT_ID_PROD_26 }}
      NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET_PROD_26 }}
      NEXT_PUBLIC_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID_PROD_26 }}
      NEXT_PUBLIC_APP_ID: ${{ secrets.NEXT_PUBLIC_APP_ID_PROD_26 }}
      NEXT_PUBLIC_STATUS: prod-26

    steps:
      - uses: actions/checkout@v4
      - run: npm ci && npm run build

      - name: Deploy through FTP	
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:	
          server: ${{ secrets.FTP_SERVER }}	
          username: ${{ secrets.FTP_USERNAME }}	
          password: ${{ secrets.FTP_PASSWORD }}	
          local-dir: ./out/
          server-dir: ./	
          protocol: ftp
          port: 21

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD_26 }}
          projectId: rur-26-web-prod
          channelId: live
          target: prod-26

  # Dev branch deployment - Firebase hosting with environment selection
  deploy_dev_prod_26:
    if: github.ref == 'refs/heads/dev' && (github.event.inputs.environment == 'all' || github.event.inputs.environment == 'prod-26' || github.event.inputs.environment == '')
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY_PROD_26 }}
      NEXT_PUBLIC_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN_PROD_26 }}
      NEXT_PUBLIC_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROJECT_ID_PROD_26 }}
      NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET_PROD_26 }}
      NEXT_PUBLIC_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID_PROD_26 }}
      NEXT_PUBLIC_APP_ID: ${{ secrets.NEXT_PUBLIC_APP_ID_PROD_26 }}
      NEXT_PUBLIC_STATUS: prod-26

    steps:
      - uses: actions/checkout@v4
      - run: npm ci && npm run build

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD_26 }}
          projectId: rur-26-web-prod
          channelId: dev-branch
          target: prod-26

  deploy_dev_prod_27:
    if: github.ref == 'refs/heads/dev' && (github.event.inputs.environment == 'all' || github.event.inputs.environment == 'prod-27' || github.event.inputs.environment == '')
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY_PROD_27 }}
      NEXT_PUBLIC_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN_PROD_27 }}
      NEXT_PUBLIC_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROJECT_ID_PROD_27 }}
      NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET_PROD_27 }}
      NEXT_PUBLIC_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID_PROD_27 }}
      NEXT_PUBLIC_APP_ID: ${{ secrets.NEXT_PUBLIC_APP_ID_PROD_27 }}
      NEXT_PUBLIC_STATUS: prod-27

    steps:
      - uses: actions/checkout@v4
      - run: npm ci && npm run build

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD_27 }}
          projectId: rur-27-web-prod
          channelId: dev-branch
          target: prod-27

  deploy_dev_dev:
    if: github.ref == 'refs/heads/dev' && (github.event.inputs.environment == 'all' || github.event.inputs.environment == 'dev' || github.event.inputs.environment == '')
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY_DEV }}
      NEXT_PUBLIC_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN_DEV }}
      NEXT_PUBLIC_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROJECT_ID_DEV }}
      NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET_DEV }}
      NEXT_PUBLIC_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID_DEV }}
      NEXT_PUBLIC_APP_ID: ${{ secrets.NEXT_PUBLIC_APP_ID_DEV }}
      NEXT_PUBLIC_STATUS: dev

    steps:
      - uses: actions/checkout@v4
      - run: npm ci && npm run build

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}
          projectId: rur-web-dev
          channelId: dev-branch
          target: dev
